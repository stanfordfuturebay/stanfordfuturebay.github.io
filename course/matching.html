<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4.3 Matching | Shaping the Future of the Bay Area: Intro to Urban Data Analytics in R</title>
  <meta name="description" content="4.3 Matching | Shaping the Future of the Bay Area: Intro to Urban Data Analytics in R" />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="4.3 Matching | Shaping the Future of the Bay Area: Intro to Urban Data Analytics in R" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4.3 Matching | Shaping the Future of the Bay Area: Intro to Urban Data Analytics in R" />
  
  
  

<meta name="author" content="Stanford Future Bay Initiative" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="training-and-testing-data.html"/>
<link rel="next" href="difference-in-differences.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="libs/pagedtable-1.1/js/pagedtable.js"></script>
<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<script src="libs/plotly-binding-4.9.2.1/plotly.js"></script>
<script src="libs/typedarray-0.1/typedarray.min.js"></script>
<link href="libs/crosstalk-1.1.0.1/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.1.0.1/js/crosstalk.min.js"></script>
<link href="libs/plotly-htmlwidgets-css-1.52.2/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotly-main-1.52.2/plotly-latest.min.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/Proj4Leaflet-1.0.1/proj4-compressed.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.3/leaflet.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.0.3/leaflet-providers-plugin.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="https://bay.stanford.edu">Stanford Future Bay Initiative</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="software-setup.html"><a href="software-setup.html"><i class="fa fa-check"></i><b>1.1</b> Software Setup</a></li>
<li class="chapter" data-level="1.2" data-path="rstudio-interface.html"><a href="rstudio-interface.html"><i class="fa fa-check"></i><b>1.2</b> RStudio Interface</a></li>
<li class="chapter" data-level="1.3" data-path="r-markdown-files.html"><a href="r-markdown-files.html"><i class="fa fa-check"></i><b>1.3</b> R Markdown Files</a></li>
<li class="chapter" data-level="1.4" data-path="github.html"><a href="github.html"><i class="fa fa-check"></i><b>1.4</b> GitHub</a></li>
<li class="chapter" data-level="1.5" data-path="reading-and-saving-files.html"><a href="reading-and-saving-files.html"><i class="fa fa-check"></i><b>1.5</b> Reading and saving files</a></li>
<li class="chapter" data-level="1.6" data-path="loops.html"><a href="loops.html"><i class="fa fa-check"></i><b>1.6</b> Loops</a></li>
<li class="chapter" data-level="1.7" data-path="manipulating-data.html"><a href="manipulating-data.html"><i class="fa fa-check"></i><b>1.7</b> Manipulating data</a></li>
<li class="chapter" data-level="1.8" data-path="plots.html"><a href="plots.html"><i class="fa fa-check"></i><b>1.8</b> Plots</a></li>
<li class="chapter" data-level="1.9" data-path="geospatial-data.html"><a href="geospatial-data.html"><i class="fa fa-check"></i><b>1.9</b> Geospatial data</a></li>
<li class="chapter" data-level="1.10" data-path="assignment-1.html"><a href="assignment-1.html"><i class="fa fa-check"></i><b>1.10</b> Assignment 1</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="populations.html"><a href="populations.html"><i class="fa fa-check"></i><b>2</b> Populations</a><ul>
<li class="chapter" data-level="2.1" data-path="census-data.html"><a href="census-data.html"><i class="fa fa-check"></i><b>2.1</b> Census data</a></li>
<li class="chapter" data-level="2.2" data-path="equity-analysis.html"><a href="equity-analysis.html"><i class="fa fa-check"></i><b>2.2</b> Equity analysis</a></li>
<li class="chapter" data-level="2.3" data-path="migration.html"><a href="migration.html"><i class="fa fa-check"></i><b>2.3</b> Migration</a></li>
<li class="chapter" data-level="2.4" data-path="microdata.html"><a href="microdata.html"><i class="fa fa-check"></i><b>2.4</b> Microdata</a></li>
<li class="chapter" data-level="2.5" data-path="spatial-subsets.html"><a href="spatial-subsets.html"><i class="fa fa-check"></i><b>2.5</b> Spatial subsets</a></li>
<li class="chapter" data-level="2.6" data-path="assignment-2.html"><a href="assignment-2.html"><i class="fa fa-check"></i><b>2.6</b> Assignment 2</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="statistics-part-1.html"><a href="statistics-part-1.html"><i class="fa fa-check"></i><b>3</b> Statistics, Part 1</a><ul>
<li class="chapter" data-level="3.1" data-path="probability-distributions.html"><a href="probability-distributions.html"><i class="fa fa-check"></i><b>3.1</b> Probability distributions</a></li>
<li class="chapter" data-level="3.2" data-path="monte-carlo-simulations.html"><a href="monte-carlo-simulations.html"><i class="fa fa-check"></i><b>3.2</b> Monte Carlo simulations</a></li>
<li class="chapter" data-level="3.3" data-path="simple-linear-regression.html"><a href="simple-linear-regression.html"><i class="fa fa-check"></i><b>3.3</b> Simple linear regression</a></li>
<li class="chapter" data-level="3.4" data-path="sampling-bias.html"><a href="sampling-bias.html"><i class="fa fa-check"></i><b>3.4</b> Sampling bias</a></li>
<li class="chapter" data-level="3.5" data-path="multiple-regression.html"><a href="multiple-regression.html"><i class="fa fa-check"></i><b>3.5</b> Multiple regression</a></li>
<li class="chapter" data-level="3.6" data-path="assignment-3.html"><a href="assignment-3.html"><i class="fa fa-check"></i><b>3.6</b> Assignment 3</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="statistics-part-2.html"><a href="statistics-part-2.html"><i class="fa fa-check"></i><b>4</b> Statistics, Part 2</a><ul>
<li class="chapter" data-level="4.1" data-path="logistic-regression.html"><a href="logistic-regression.html"><i class="fa fa-check"></i><b>4.1</b> Logistic regression</a></li>
<li class="chapter" data-level="4.2" data-path="training-and-testing-data.html"><a href="training-and-testing-data.html"><i class="fa fa-check"></i><b>4.2</b> Training and testing data</a></li>
<li class="chapter" data-level="4.3" data-path="matching.html"><a href="matching.html"><i class="fa fa-check"></i><b>4.3</b> Matching</a></li>
<li class="chapter" data-level="4.4" data-path="difference-in-differences.html"><a href="difference-in-differences.html"><i class="fa fa-check"></i><b>4.4</b> Difference-in-differences</a></li>
<li class="chapter" data-level="4.5" data-path="assignment-4.html"><a href="assignment-4.html"><i class="fa fa-check"></i><b>4.5</b> Assignment 4</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="mobility.html"><a href="mobility.html"><i class="fa fa-check"></i><b>5</b> Mobility</a><ul>
<li class="chapter" data-level="5.1" data-path="travel-survey-data.html"><a href="travel-survey-data.html"><i class="fa fa-check"></i><b>5.1</b> Travel survey data</a></li>
<li class="chapter" data-level="5.2" data-path="commute-data.html"><a href="commute-data.html"><i class="fa fa-check"></i><b>5.2</b> Commute data</a></li>
<li class="chapter" data-level="5.3" data-path="routing.html"><a href="routing.html"><i class="fa fa-check"></i><b>5.3</b> Routing</a></li>
<li class="chapter" data-level="5.4" data-path="accessibility.html"><a href="accessibility.html"><i class="fa fa-check"></i><b>5.4</b> Accessibility</a></li>
<li class="chapter" data-level="5.5" data-path="assignment-5.html"><a href="assignment-5.html"><i class="fa fa-check"></i><b>5.5</b> Assignment 5</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="land-use.html"><a href="land-use.html"><i class="fa fa-check"></i><b>6</b> Land Use</a><ul>
<li class="chapter" data-level="6.1" data-path="housing-data.html"><a href="housing-data.html"><i class="fa fa-check"></i><b>6.1</b> Housing data</a></li>
<li class="chapter" data-level="6.2" data-path="parcel-data.html"><a href="parcel-data.html"><i class="fa fa-check"></i><b>6.2</b> Parcel data</a></li>
<li class="chapter" data-level="6.3" data-path="census-to-parcel-disaggregation.html"><a href="census-to-parcel-disaggregation.html"><i class="fa fa-check"></i><b>6.3</b> Census-to-parcel disaggregation</a></li>
<li class="chapter" data-level="6.4" data-path="parcel-and-building-geometries.html"><a href="parcel-and-building-geometries.html"><i class="fa fa-check"></i><b>6.4</b> Parcel and building geometries</a></li>
<li class="chapter" data-level="6.5" data-path="address-geocoding-and-matching.html"><a href="address-geocoding-and-matching.html"><i class="fa fa-check"></i><b>6.5</b> Address geocoding and matching</a></li>
<li class="chapter" data-level="6.6" data-path="assignment-6.html"><a href="assignment-6.html"><i class="fa fa-check"></i><b>6.6</b> Assignment 6</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="sustainability.html"><a href="sustainability.html"><i class="fa fa-check"></i><b>7</b> Sustainability</a><ul>
<li class="chapter" data-level="7.1" data-path="vehicle-emissions.html"><a href="vehicle-emissions.html"><i class="fa fa-check"></i><b>7.1</b> Vehicle emissions</a></li>
<li class="chapter" data-level="7.2" data-path="building-emissions.html"><a href="building-emissions.html"><i class="fa fa-check"></i><b>7.2</b> Building emissions</a></li>
<li class="chapter" data-level="7.3" data-path="air-pollution-data.html"><a href="air-pollution-data.html"><i class="fa fa-check"></i><b>7.3</b> Air pollution data</a></li>
<li class="chapter" data-level="7.4" data-path="household-consumption.html"><a href="household-consumption.html"><i class="fa fa-check"></i><b>7.4</b> Household consumption</a></li>
<li class="chapter" data-level="7.5" data-path="assignment-7.html"><a href="assignment-7.html"><i class="fa fa-check"></i><b>7.5</b> Assignment 7</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="hazards.html"><a href="hazards.html"><i class="fa fa-check"></i><b>8</b> Hazards</a><ul>
<li class="chapter" data-level="8.1" data-path="hazard-data.html"><a href="hazard-data.html"><i class="fa fa-check"></i><b>8.1</b> Hazard data</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Shaping the Future of the Bay Area: Intro to Urban Data Analytics in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="matching" class="section level2">
<h2><span class="header-section-number">4.3</span> Matching</h2>
<p>At this point of the chapter, we move towards quasi-experimental designs, which are potential tools for causal inference where a gold-standard randomized control trial may not be possible for practical or ethical reasons. Across a few different techniques available, it is often useful to conduct “matching”, where a sample of units that receive a treatment is matched with a sample of units that did not receive the treatment, and otherwise are comparable on all observed covariates (independent variables). For our purposes, we’ll usually focus on CBGs or similar Census geographies as the unit of analysis. The goal is generally to be able to find matching CBGs for an initial CBG of interest, and to base that matching off of a handful of ACS variables we can observe for the CBG. Because those multiple variables are different dimensions of information, we need a mathematical approach to “similarity” across multiple dimensions.</p>
<p>One technique, propensity score matching, effectively involves creating a logit model as we did in Section 4.1, and matching based on the resultant one-dimensional logit score. However, for a propensity score to work, one would need an “outcome variable” to be predicting, which is not always available or relevant. Another technique is called <a href="https://en.wikipedia.org/wiki/Mahalanobis_distance">Mahalanobis matching</a>, which is a way to measure distance between a point and a distribution of observed points across multiple dimensions. This technique works best with fewer than 8 variables, and preferably continuous variables. This tends to reflect the information we work with when working with CBGs or other Census geographies.</p>
<p>Let’s say we were looking at tracts in the Bay Area and comparing them along the characteristics of income, race, and education. As we’ve done before, we first load the data using <code>censusapi</code>. We’ll need a new package, <code>StatMatch</code>, to use calculate Mahalanobis distance, so go ahead and <code>install.packages("StatMatch")</code> and load the library.</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="matching.html#cb212-1"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb212-2"><a href="matching.html#cb212-2"></a><span class="kw">library</span>(censusapi)</span>
<span id="cb212-3"><a href="matching.html#cb212-3"></a><span class="kw">library</span>(StatMatch)</span>
<span id="cb212-4"><a href="matching.html#cb212-4"></a></span>
<span id="cb212-5"><a href="matching.html#cb212-5"></a><span class="kw">Sys.setenv</span>(<span class="dt">CENSUS_KEY=</span><span class="st">&quot;c8aa67e4086b4b5ce3a8717f59faa9a28f611dab&quot;</span>)</span>
<span id="cb212-6"><a href="matching.html#cb212-6"></a></span>
<span id="cb212-7"><a href="matching.html#cb212-7"></a>acs_vars_<span class="dv">2018</span>_5yr &lt;-</span>
<span id="cb212-8"><a href="matching.html#cb212-8"></a><span class="st">  </span><span class="kw">listCensusMetadata</span>(</span>
<span id="cb212-9"><a href="matching.html#cb212-9"></a>    <span class="dt">name =</span> <span class="st">&quot;2018/acs/acs5&quot;</span>,</span>
<span id="cb212-10"><a href="matching.html#cb212-10"></a>    <span class="dt">type =</span> <span class="st">&quot;variables&quot;</span></span>
<span id="cb212-11"><a href="matching.html#cb212-11"></a>  )</span>
<span id="cb212-12"><a href="matching.html#cb212-12"></a></span>
<span id="cb212-13"><a href="matching.html#cb212-13"></a>bay_tracts &lt;-</span>
<span id="cb212-14"><a href="matching.html#cb212-14"></a><span class="st">  </span><span class="kw">tracts</span>(<span class="st">&quot;CA&quot;</span>, bay_county_names, <span class="dt">cb =</span> T, <span class="dt">progress_bar =</span> F)</span>
<span id="cb212-15"><a href="matching.html#cb212-15"></a></span>
<span id="cb212-16"><a href="matching.html#cb212-16"></a>bay_multiple_tract &lt;-<span class="st"> </span></span>
<span id="cb212-17"><a href="matching.html#cb212-17"></a><span class="st">  </span><span class="kw">getCensus</span>(</span>
<span id="cb212-18"><a href="matching.html#cb212-18"></a>    <span class="dt">name =</span> <span class="st">&quot;acs/acs5&quot;</span>,</span>
<span id="cb212-19"><a href="matching.html#cb212-19"></a>    <span class="dt">vintage =</span> <span class="dv">2018</span>,</span>
<span id="cb212-20"><a href="matching.html#cb212-20"></a>    <span class="dt">region =</span> <span class="st">&quot;tract:*&quot;</span>,</span>
<span id="cb212-21"><a href="matching.html#cb212-21"></a>    <span class="dt">regionin =</span> <span class="st">&quot;state:06+county:001,013,041,055,075,081,085,095,097&quot;</span>,</span>
<span id="cb212-22"><a href="matching.html#cb212-22"></a>    <span class="dt">vars =</span> <span class="kw">c</span>(</span>
<span id="cb212-23"><a href="matching.html#cb212-23"></a>      <span class="st">&quot;B19001A_001E&quot;</span>,</span>
<span id="cb212-24"><a href="matching.html#cb212-24"></a>      <span class="st">&quot;B19001_001E&quot;</span>,</span>
<span id="cb212-25"><a href="matching.html#cb212-25"></a>      <span class="st">&quot;B19001_014E&quot;</span>,</span>
<span id="cb212-26"><a href="matching.html#cb212-26"></a>      <span class="st">&quot;B19001_015E&quot;</span>,</span>
<span id="cb212-27"><a href="matching.html#cb212-27"></a>      <span class="st">&quot;B19001_016E&quot;</span>,</span>
<span id="cb212-28"><a href="matching.html#cb212-28"></a>      <span class="st">&quot;B19001_017E&quot;</span>,</span>
<span id="cb212-29"><a href="matching.html#cb212-29"></a>      <span class="st">&quot;B15003_001E&quot;</span>,</span>
<span id="cb212-30"><a href="matching.html#cb212-30"></a>      <span class="st">&quot;B15003_021E&quot;</span>,</span>
<span id="cb212-31"><a href="matching.html#cb212-31"></a>      <span class="st">&quot;B15003_022E&quot;</span>,</span>
<span id="cb212-32"><a href="matching.html#cb212-32"></a>      <span class="st">&quot;B15003_023E&quot;</span>,</span>
<span id="cb212-33"><a href="matching.html#cb212-33"></a>      <span class="st">&quot;B15003_024E&quot;</span>,</span>
<span id="cb212-34"><a href="matching.html#cb212-34"></a>      <span class="st">&quot;B15003_025E&quot;</span></span>
<span id="cb212-35"><a href="matching.html#cb212-35"></a>    )</span>
<span id="cb212-36"><a href="matching.html#cb212-36"></a>  ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb212-37"><a href="matching.html#cb212-37"></a><span class="st">  </span><span class="kw">transmute</span>(</span>
<span id="cb212-38"><a href="matching.html#cb212-38"></a>    <span class="dt">tract =</span> <span class="kw">paste0</span>(state, county, tract),</span>
<span id="cb212-39"><a href="matching.html#cb212-39"></a>    <span class="dt">perc_white =</span> B19001A_001E <span class="op">/</span><span class="st"> </span>B19001_001E,</span>
<span id="cb212-40"><a href="matching.html#cb212-40"></a>    <span class="dt">perc_over100k =</span> (B19001_014E <span class="op">+</span><span class="st"> </span>B19001_015E <span class="op">+</span><span class="st"> </span>B19001_016E <span class="op">+</span><span class="st"> </span>B19001_017E) <span class="op">/</span><span class="st"> </span>B19001_001E,</span>
<span id="cb212-41"><a href="matching.html#cb212-41"></a>    <span class="dt">perc_collegedegree =</span> (B15003_021E <span class="op">+</span><span class="st"> </span>B15003_022E <span class="op">+</span><span class="st"> </span>B15003_023E <span class="op">+</span><span class="st"> </span>B15003_024E <span class="op">+</span>B15003_025E) <span class="op">/</span><span class="st"> </span>B15003_001E</span>
<span id="cb212-42"><a href="matching.html#cb212-42"></a>  ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb212-43"><a href="matching.html#cb212-43"></a><span class="st">  </span><span class="kw">filter</span>(</span>
<span id="cb212-44"><a href="matching.html#cb212-44"></a>    <span class="op">!</span><span class="kw">is.na</span>(perc_white), </span>
<span id="cb212-45"><a href="matching.html#cb212-45"></a>    <span class="op">!</span><span class="kw">is.na</span>(perc_over100k),</span>
<span id="cb212-46"><a href="matching.html#cb212-46"></a>    <span class="op">!</span><span class="kw">is.na</span>(perc_collegedegree)</span>
<span id="cb212-47"><a href="matching.html#cb212-47"></a>  )</span></code></pre></div>
<p>Next, we’ll retain just the three fields of relevant variables in matrix form:</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="matching.html#cb213-1"></a>obs_matrix &lt;-</span>
<span id="cb213-2"><a href="matching.html#cb213-2"></a><span class="st">  </span>bay_multiple_tract <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb213-3"><a href="matching.html#cb213-3"></a><span class="st">  </span><span class="kw">select</span>(</span>
<span id="cb213-4"><a href="matching.html#cb213-4"></a>    perc_white, </span>
<span id="cb213-5"><a href="matching.html#cb213-5"></a>    perc_over100k,</span>
<span id="cb213-6"><a href="matching.html#cb213-6"></a>    perc_collegedegree</span>
<span id="cb213-7"><a href="matching.html#cb213-7"></a>  ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb213-8"><a href="matching.html#cb213-8"></a><span class="st">  </span><span class="kw">as.matrix</span>()</span></code></pre></div>
<p>Now, <code>mahalanobis.dist()</code> from the <code>StatMatch</code> package can be used. When given one argument (in this case our matrix), the function will create a resultant matrix that has as many rows and columns as number of observations in the original data, and each cell will be the Mahalanobis distance between the pair of records, a single number that accounts for our three ACS dimensions (the lower the better). For simplicity of reference in the following steps, we’ll also rename the <code>rownames()</code> and <code>colnames()</code> of the matrix by the relevant <code>tract</code> ID, which will have maintained the same order as the original <code>bay_multiple_tract</code> dataframe.</p>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb214-1"><a href="matching.html#cb214-1"></a>dist_matrix &lt;-<span class="st"> </span><span class="kw">mahalanobis.dist</span>(obs_matrix)</span>
<span id="cb214-2"><a href="matching.html#cb214-2"></a></span>
<span id="cb214-3"><a href="matching.html#cb214-3"></a><span class="kw">rownames</span>(dist_matrix) &lt;-<span class="st"> </span>bay_multiple_tract<span class="op">$</span>tract</span>
<span id="cb214-4"><a href="matching.html#cb214-4"></a><span class="kw">colnames</span>(dist_matrix) &lt;-<span class="st"> </span>bay_multiple_tract<span class="op">$</span>tract</span></code></pre></div>
<p>If you <code>View(dist_matrix)</code>, you’ll notice the renamed <code>rownames</code> and <code>colnames</code>, and also that the diagonal values are 0 because there will be no distance when pairing a tract with itself. The matrix is also symmetrical, so only the top-right or bottom-left triangle of the matrix is technically necessary to convey all unique information, but the practical usage of this matrix will involve referencing entire rows.</p>
<p>If we wanted to pair every tract with its one closest match, we could hold identify the minimum Malahanobis distance value from each row (besides the diagonal 0s) and then retain the appropriate column name:</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="matching.html#cb215-1"></a>dist_matrix_pairmatch &lt;-<span class="st"> </span>dist_matrix</span>
<span id="cb215-2"><a href="matching.html#cb215-2"></a><span class="kw">diag</span>(dist_matrix_pairmatch) &lt;-<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb215-3"><a href="matching.html#cb215-3"></a></span>
<span id="cb215-4"><a href="matching.html#cb215-4"></a>matched_pair_tract &lt;-</span>
<span id="cb215-5"><a href="matching.html#cb215-5"></a><span class="st">  </span><span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(dist_matrix_pairmatch) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb215-6"><a href="matching.html#cb215-6"></a><span class="st">  </span><span class="kw">map_dfr</span>(<span class="cf">function</span>(x){</span>
<span id="cb215-7"><a href="matching.html#cb215-7"></a>    </span>
<span id="cb215-8"><a href="matching.html#cb215-8"></a>    min_index &lt;-<span class="st"> </span><span class="kw">which</span>(dist_matrix_pairmatch[x, ] <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(dist_matrix_pairmatch[x, ], <span class="dt">na.rm =</span> T))</span>
<span id="cb215-9"><a href="matching.html#cb215-9"></a>   </span>
<span id="cb215-10"><a href="matching.html#cb215-10"></a>    <span class="kw">data.frame</span>(</span>
<span id="cb215-11"><a href="matching.html#cb215-11"></a>      <span class="dt">tract =</span> bay_multiple_tract<span class="op">$</span>tract[x],</span>
<span id="cb215-12"><a href="matching.html#cb215-12"></a>      <span class="dt">matched_tract =</span> bay_multiple_tract<span class="op">$</span>tract[min_index]</span>
<span id="cb215-13"><a href="matching.html#cb215-13"></a>    )</span>
<span id="cb215-14"><a href="matching.html#cb215-14"></a>    </span>
<span id="cb215-15"><a href="matching.html#cb215-15"></a>  })</span></code></pre></div>
<p>Note that <code>which()</code> specifically returns the index for which the logical condition is true, which is particularly useful to then use within a bracket in the following step. Also, <code>diag() &lt;- NA</code> helps to prevent the 0s in the diagonals from being considered when we look for the <code>min()</code> distance score. The following map shows three examples of pairs:</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="matching.html#cb216-1"></a><span class="kw">leaflet</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb216-2"><a href="matching.html#cb216-2"></a><span class="st">  </span><span class="kw">addProviderTiles</span>(providers<span class="op">$</span>CartoDB.Positron) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb216-3"><a href="matching.html#cb216-3"></a><span class="st">  </span><span class="kw">addPolygons</span>(</span>
<span id="cb216-4"><a href="matching.html#cb216-4"></a>    <span class="dt">data =</span> bay_tracts <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb216-5"><a href="matching.html#cb216-5"></a><span class="st">      </span><span class="kw">filter</span>(GEOID <span class="op">==</span><span class="st"> </span>matched_pair_tract[<span class="dv">2</span>,<span class="dv">1</span>])</span>
<span id="cb216-6"><a href="matching.html#cb216-6"></a>  ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb216-7"><a href="matching.html#cb216-7"></a><span class="st">  </span><span class="kw">addPolygons</span>(</span>
<span id="cb216-8"><a href="matching.html#cb216-8"></a>    <span class="dt">data =</span> bay_tracts <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb216-9"><a href="matching.html#cb216-9"></a><span class="st">      </span><span class="kw">filter</span>(GEOID <span class="op">==</span><span class="st"> </span>matched_pair_tract[<span class="dv">2</span>,<span class="dv">2</span>])</span>
<span id="cb216-10"><a href="matching.html#cb216-10"></a>  ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb216-11"><a href="matching.html#cb216-11"></a><span class="st">  </span><span class="kw">addPolygons</span>(</span>
<span id="cb216-12"><a href="matching.html#cb216-12"></a>    <span class="dt">data =</span> bay_tracts <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb216-13"><a href="matching.html#cb216-13"></a><span class="st">      </span><span class="kw">filter</span>(GEOID <span class="op">==</span><span class="st"> </span>matched_pair_tract[<span class="dv">3</span>,<span class="dv">1</span>]),</span>
<span id="cb216-14"><a href="matching.html#cb216-14"></a>    <span class="dt">color =</span> <span class="st">&quot;green&quot;</span></span>
<span id="cb216-15"><a href="matching.html#cb216-15"></a>  ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb216-16"><a href="matching.html#cb216-16"></a><span class="st">  </span><span class="kw">addPolygons</span>(</span>
<span id="cb216-17"><a href="matching.html#cb216-17"></a>    <span class="dt">data =</span> bay_tracts <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb216-18"><a href="matching.html#cb216-18"></a><span class="st">      </span><span class="kw">filter</span>(GEOID <span class="op">==</span><span class="st"> </span>matched_pair_tract[<span class="dv">3</span>,<span class="dv">2</span>]),</span>
<span id="cb216-19"><a href="matching.html#cb216-19"></a>    <span class="dt">color =</span> <span class="st">&quot;green&quot;</span></span>
<span id="cb216-20"><a href="matching.html#cb216-20"></a>  ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb216-21"><a href="matching.html#cb216-21"></a><span class="st">  </span><span class="kw">addPolygons</span>(</span>
<span id="cb216-22"><a href="matching.html#cb216-22"></a>    <span class="dt">data =</span> bay_tracts <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb216-23"><a href="matching.html#cb216-23"></a><span class="st">      </span><span class="kw">filter</span>(GEOID <span class="op">==</span><span class="st"> </span>matched_pair_tract[<span class="dv">5</span>,<span class="dv">1</span>]),</span>
<span id="cb216-24"><a href="matching.html#cb216-24"></a>    <span class="dt">color =</span> <span class="st">&quot;red&quot;</span></span>
<span id="cb216-25"><a href="matching.html#cb216-25"></a>  ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb216-26"><a href="matching.html#cb216-26"></a><span class="st">  </span><span class="kw">addPolygons</span>(</span>
<span id="cb216-27"><a href="matching.html#cb216-27"></a>    <span class="dt">data =</span> bay_tracts <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb216-28"><a href="matching.html#cb216-28"></a><span class="st">      </span><span class="kw">filter</span>(GEOID <span class="op">==</span><span class="st"> </span>matched_pair_tract[<span class="dv">5</span>,<span class="dv">2</span>]),</span>
<span id="cb216-29"><a href="matching.html#cb216-29"></a>    <span class="dt">color =</span> <span class="st">&quot;red&quot;</span></span>
<span id="cb216-30"><a href="matching.html#cb216-30"></a>  )</span></code></pre></div>
<div id="htmlwidget-8c2388d79f111cd0854c" style="width:672px;height:480px;" class="leaflet html-widget"></div>
<script type="application/json" data-for="htmlwidget-8c2388d79f111cd0854c">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addProviderTiles","args":["CartoDB.Positron",null,null,{"errorTileUrl":"","noWrap":false,"detectRetina":false}]},{"method":"addPolygons","args":[[[[{"lng":[-122.283981,-122.276915,-122.276252,-122.274072,-122.272546,-122.271775,-122.27173,-122.27166,-122.271621,-122.26758,-122.266353,-122.263329,-122.255997,-122.255954,-122.256583,-122.255579,-122.254447,-122.252716,-122.255068,-122.256939,-122.261222,-122.264359,-122.265621,-122.26877,-122.269435,-122.27277,-122.275767,-122.282268,-122.283392,-122.281659,-122.279389,-122.27896,-122.280024,-122.281404,-122.282163,-122.28216,-122.277763,-122.278157,-122.276713,-122.277142,-122.277995,-122.278574,-122.28032,-122.280345,-122.281639,-122.283215,-122.283981],"lat":[38.324911,38.325106,38.325146,38.325178,38.32268,38.322699,38.322735,38.322839,38.322915,38.324398,38.323491,38.323936,38.323431,38.31523,38.313427,38.306877,38.305385,38.295171,38.29427,38.295256,38.296382,38.296165,38.29651,38.297373,38.297445,38.297822,38.29946,38.298524,38.298105,38.299838,38.299426,38.302444,38.304208,38.302584,38.302549,38.305336,38.310454,38.31303,38.314683,38.316749,38.31748,38.317793,38.318207,38.318165,38.31871,38.323532,38.324911]}]]],null,null,{"interactive":true,"className":"","stroke":true,"color":"#03F","weight":5,"opacity":0.5,"fill":true,"fillColor":"#03F","fillOpacity":0.2,"smoothFactor":1,"noClip":false},null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addPolygons","args":[[[[{"lng":[-122.567485,-122.56572,-122.565972,-122.564993,-122.562181,-122.558481,-122.551346,-122.541748,-122.54108,-122.539481,-122.535493,-122.528868,-122.52129,-122.520226,-122.513241,-122.512527,-122.50914,-122.506845,-122.506169,-122.504322,-122.498436,-122.49812,-122.496882,-122.492472,-122.490896,-122.490379,-122.490052,-122.489441,-122.490787,-122.490261,-122.490546,-122.488382,-122.485404,-122.481338,-122.48414,-122.487933,-122.492683,-122.490798,-122.490832,-122.492193,-122.49092,-122.492617,-122.491022,-122.488601,-122.486769,-122.487256,-122.490873,-122.490966,-122.481398,-122.481437,-122.479021,-122.478594,-122.476308,-122.470866,-122.46953,-122.465256,-122.461529,-122.45956,-122.453908,-122.442009,-122.440328,-122.435854,-122.436319,-122.434816,-122.432494,-122.432284,-122.427866,-122.42584,-122.424418,-122.418811,-122.411539,-122.407375,-122.404375,-122.402418,-122.400194,-122.398499,-122.389681,-122.38411,-122.381305,-122.378477,-122.374426,-122.365692,-122.36456,-122.362133,-122.360761,-122.359553,-122.353461,-122.351387,-122.350466,-122.345817,-122.343188,-122.341167,-122.351772,-122.355248,-122.357323,-122.36055,-122.36233,-122.365913,-122.369976,-122.373061,-122.374316,-122.376451,-122.37935,-122.380786,-122.386011,-122.390284,-122.398417,-122.400501,-122.402686,-122.411308,-122.412373,-122.414601,-122.416693,-122.417724,-122.423313,-122.425503,-122.427071,-122.426909,-122.425935,-122.425399,-122.426467,-122.426159,-122.427249,-122.428682,-122.42871,-122.431352,-122.432934,-122.441023,-122.442478,-122.445036,-122.446713,-122.450607,-122.453395,-122.45495,-122.456543,-122.457899,-122.462111,-122.46328,-122.467255,-122.47002,-122.470609,-122.472079,-122.4724,-122.47539,-122.475591,-122.494397,-122.497191,-122.497475,-122.493491,-122.494191,-122.491391,-122.487107,-122.485507,-122.484195,-122.483043,-122.480003,-122.479955,-122.482991,-122.485391,-122.488391,-122.492091,-122.493691,-122.496846,-122.50155,-122.504067,-122.507287,-122.509728,-122.508569,-122.508843,-122.510049,-122.508192,-122.505822,-122.508798,-122.511117,-122.516244,-122.517175,-122.520318,-122.522637,-122.524804,-122.529592,-122.529626,-122.531335,-122.531396,-122.533532,-122.53608,-122.538009,-122.538223,-122.540536,-122.540978,-122.544733,-122.543923,-122.541253,-122.538201,-122.535491,-122.538796,-122.541238,-122.542962,-122.54316,-122.545527,-122.54722,-122.548807,-122.54632,-122.542367,-122.542871,-122.545298,-122.543557,-122.543893,-122.546393,-122.547175,-122.550623,-122.552782,-122.557133,-122.561899,-122.563608,-122.566644,-122.566629,-122.569473,-122.567485],"lat":[38.530381,38.531908,38.535863,38.536797,38.538149,38.538632,38.541592,38.543255,38.544033,38.5452,38.546319,38.54757,38.551237,38.552412,38.555986,38.556832,38.558121,38.557801,38.556481,38.556181,38.553031,38.552345,38.550412,38.548632,38.547468,38.546202,38.540683,38.538948,38.533376,38.531912,38.529915,38.528377,38.528399,38.524813,38.521114,38.517505,38.513982,38.512551,38.510483,38.510949,38.508885,38.507312,38.506747,38.506907,38.506105,38.50402,38.504326,38.494622,38.494659,38.48816,38.48693,38.487495,38.486527,38.486494,38.48698,38.486948,38.489694,38.48801,38.492196,38.501013,38.498652,38.501937,38.502064,38.502072,38.499813,38.498308,38.497335,38.495096,38.497079,38.493143,38.490042,38.48796,38.486894,38.486183,38.48343,38.482184,38.477383,38.472263,38.469322,38.46742,38.463886,38.458438,38.457526,38.453822,38.45063,38.449235,38.445128,38.439618,38.438293,38.431493,38.429625,38.427615,38.41828,38.419544,38.42112,38.421987,38.42147,38.422155,38.421177,38.422657,38.42443,38.425872,38.426749,38.426631,38.42468,38.422537,38.431971,38.434248,38.432493,38.425473,38.423506,38.42191,38.422103,38.421423,38.421103,38.422387,38.421755,38.419917,38.418928,38.416521,38.415266,38.414114,38.41133,38.411352,38.408713,38.408047,38.407176,38.406376,38.407576,38.408222,38.409512,38.410548,38.410543,38.409806,38.408111,38.409089,38.409068,38.408241,38.40886,38.408797,38.407506,38.407387,38.405514,38.406511,38.409111,38.422719,38.423811,38.424306,38.42921,38.43111,38.43441,38.431718,38.437478,38.438006,38.44039,38.44303,38.448726,38.45271,38.45291,38.45431,38.45451,38.45651,38.455634,38.455919,38.45714,38.457254,38.458254,38.459184,38.460802,38.46216,38.464309,38.464493,38.467003,38.467148,38.470872,38.470246,38.471291,38.470185,38.470261,38.469609,38.47313,38.476342,38.478539,38.480729,38.482338,38.48535,38.486541,38.488312,38.491676,38.495675,38.498086,38.498917,38.497902,38.501726,38.502694,38.504174,38.506257,38.507493,38.506798,38.510338,38.511627,38.512603,38.513198,38.515747,38.516456,38.518013,38.519966,38.521208,38.521858,38.522132,38.525689,38.525485,38.526786,38.525368,38.525543,38.528625,38.529659,38.530381]}]]],null,null,{"interactive":true,"className":"","stroke":true,"color":"#03F","weight":5,"opacity":0.5,"fill":true,"fillColor":"#03F","fillOpacity":0.2,"smoothFactor":1,"noClip":false},null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addPolygons","args":[[[[{"lng":[-122.287225,-122.283933,-122.281909,-122.285211,-122.277489,-122.276683,-122.274234,-122.272646,-122.269108,-122.265041,-122.263656,-122.262589,-122.259932,-122.255524,-122.255478,-122.252151,-122.251432,-122.255283,-122.254932,-122.271483,-122.270769,-122.27098,-122.271194,-122.278883,-122.280813,-122.280902,-122.282215,-122.283825,-122.286891,-122.287085,-122.285096,-122.286282,-122.287225],"lat":[38.271963,38.27458,38.278298,38.281676,38.280839,38.280727,38.280508,38.280336,38.280197,38.280052,38.280015,38.279966,38.279858,38.279831,38.278814,38.27754,38.274803,38.272515,38.268013,38.268807,38.263959,38.257778,38.257759,38.257398,38.257308,38.25962,38.258011,38.258015,38.259875,38.261948,38.264757,38.266599,38.271963]}]]],null,null,{"interactive":true,"className":"","stroke":true,"color":"green","weight":5,"opacity":0.5,"fill":true,"fillColor":"green","fillOpacity":0.2,"smoothFactor":1,"noClip":false},null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addPolygons","args":[[[[{"lng":[-121.858368,-121.855788,-121.850366,-121.847534,-121.84616,-121.842294,-121.840549,-121.838268,-121.831302,-121.830317,-121.828067,-121.822671,-121.818175,-121.815673,-121.813308,-121.80931,-121.80127,-121.80125,-121.80096,-121.799088,-121.798776,-121.796946,-121.804999,-121.806009,-121.808792,-121.810024,-121.810022,-121.806003,-121.805999,-121.815062,-121.813795,-121.813786,-121.819683,-121.819666,-121.819709,-121.819898,-121.81994,-121.833338,-121.835333,-121.836253,-121.837815,-121.840316,-121.844972,-121.854893,-121.854238,-121.855877,-121.8552,-121.854998,-121.86023,-121.858368],"lat":[38.016801,38.02352,38.022332,38.029759,38.029012,38.028341,38.028548,38.029081,38.030059,38.029723,38.02802,38.025322,38.02219,38.021038,38.020535,38.020321,38.021622,38.021125,38.015638,38.014687,38.013763,38.012271,38.012224,38.010886,38.011177,38.011185,38.00491,38.004881,38.001647,38.003548,38.006192,38.010123,38.010192,38.007089,38.006111,38.004705,38.00455,38.007369,38.005645,38.004868,38.005449,38.004984,38.006269,38.009033,38.010394,38.010797,38.012515,38.013139,38.014913,38.016801]}]]],null,null,{"interactive":true,"className":"","stroke":true,"color":"green","weight":5,"opacity":0.5,"fill":true,"fillColor":"green","fillOpacity":0.2,"smoothFactor":1,"noClip":false},null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addPolygons","args":[[[[{"lng":[-122.090301,-122.087529,-122.086814,-122.086766,-122.086746,-122.08165,-122.07816,-122.07812,-122.07813,-122.07818,-122.07875,-122.08015,-122.081189,-122.081529,-122.082194,-122.091312,-122.090301],"lat":[37.403056,37.409711,37.411559,37.414097,37.416709,37.41334,37.41188,37.40612,37.40446,37.40278,37.40174,37.40066,37.399187,37.398204,37.396917,37.400534,37.403056]}]]],null,null,{"interactive":true,"className":"","stroke":true,"color":"red","weight":5,"opacity":0.5,"fill":true,"fillColor":"red","fillOpacity":0.2,"smoothFactor":1,"noClip":false},null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addPolygons","args":[[[[{"lng":[-122.406071,-122.403618,-122.399399,-122.397193,-122.395579,-122.39315,-122.390937,-122.389851,-122.388787,-122.388418,-122.390105,-122.387148,-122.384488,-122.382047,-122.379136,-122.380568,-122.377896,-122.374849,-122.379095,-122.37989,-122.382624,-122.383145,-122.380394,-122.382794,-122.383146,-122.382817,-122.382765,-122.382724,-122.382448,-122.382357,-122.380631,-122.380668,-122.380581,-122.380289,-122.380458,-122.380631,-122.380898,-122.381126,-122.381301,-122.381353,-122.381312,-122.38093,-122.38045,-122.380368,-122.381481,-122.381899,-122.382204,-122.382443,-122.383148,-122.383826,-122.386283,-122.385659,-122.389168,-122.391222,-122.393535,-122.392421,-122.390929,-122.390334,-122.390765,-122.393145,-122.393886,-122.399652,-122.400545,-122.404961,-122.406664,-122.406071],"lat":[37.584039,37.581612,37.584345,37.584959,37.585422,37.587334,37.589345,37.588634,37.590786,37.591267,37.592501,37.595636,37.597611,37.595754,37.594173,37.59247,37.590909,37.589235,37.587619,37.586761,37.586473,37.585609,37.584022,37.581334,37.580522,37.580337,37.580308,37.580285,37.58013,37.580079,37.578863,37.57861,37.578393,37.578165,37.578067,37.578026,37.578089,37.578089,37.577979,37.577863,37.577669,37.577493,37.576728,37.576526,37.575963,37.575361,37.574725,37.574808,37.574676,37.573037,37.572436,37.571315,37.568854,37.571311,37.570028,37.568897,37.567446,37.566445,37.566204,37.567072,37.567505,37.573096,37.574388,37.581953,37.584043,37.584039]}]]],null,null,{"interactive":true,"className":"","stroke":true,"color":"red","weight":5,"opacity":0.5,"fill":true,"fillColor":"red","fillOpacity":0.2,"smoothFactor":1,"noClip":false},null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]}],"limits":{"lat":[37.396917,38.558121],"lng":[-122.569473,-121.796946]}},"evals":[],"jsHooks":[]}</script>
<p>If we had a specific tract of interest (say, for instance, we knew it was “treated”), then to identify the twenty closest matching tracts (which might then be used as “controls”), we could do the following:</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="matching.html#cb217-1"></a>match_set_tract &lt;-<span class="st"> </span>dist_matrix[<span class="st">&quot;06081611900&quot;</span>, ] <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb217-2"><a href="matching.html#cb217-2"></a><span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb217-3"><a href="matching.html#cb217-3"></a><span class="st">  </span><span class="kw">rownames_to_column</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb217-4"><a href="matching.html#cb217-4"></a><span class="st">  </span><span class="kw">rename</span>(</span>
<span id="cb217-5"><a href="matching.html#cb217-5"></a>    <span class="dt">tract =</span> rowname,</span>
<span id="cb217-6"><a href="matching.html#cb217-6"></a>    <span class="dt">match =</span> <span class="st">&quot;.&quot;</span></span>
<span id="cb217-7"><a href="matching.html#cb217-7"></a>  ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb217-8"><a href="matching.html#cb217-8"></a><span class="st">  </span><span class="kw">right_join</span>(</span>
<span id="cb217-9"><a href="matching.html#cb217-9"></a>    bay_multiple_tract</span>
<span id="cb217-10"><a href="matching.html#cb217-10"></a>  ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb217-11"><a href="matching.html#cb217-11"></a><span class="st">  </span><span class="kw">arrange</span>(match) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb217-12"><a href="matching.html#cb217-12"></a><span class="st">  </span>.[<span class="dv">1</span><span class="op">:</span><span class="dv">21</span>, ] <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb217-13"><a href="matching.html#cb217-13"></a><span class="st">  </span><span class="kw">left_join</span>(bay_tracts <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dt">tract =</span> GEOID)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb217-14"><a href="matching.html#cb217-14"></a><span class="st">  </span><span class="kw">st_as_sf</span>()</span>
<span id="cb217-15"><a href="matching.html#cb217-15"></a></span>
<span id="cb217-16"><a href="matching.html#cb217-16"></a><span class="kw">leaflet</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb217-17"><a href="matching.html#cb217-17"></a><span class="st">  </span><span class="kw">addProviderTiles</span>(providers<span class="op">$</span>CartoDB.Positron) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb217-18"><a href="matching.html#cb217-18"></a><span class="st">  </span><span class="kw">addPolygons</span>(</span>
<span id="cb217-19"><a href="matching.html#cb217-19"></a>    <span class="dt">data =</span> match_set_tract[<span class="dv">1</span>, ],</span>
<span id="cb217-20"><a href="matching.html#cb217-20"></a>    <span class="dt">color =</span> <span class="st">&quot;red&quot;</span></span>
<span id="cb217-21"><a href="matching.html#cb217-21"></a>  ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb217-22"><a href="matching.html#cb217-22"></a><span class="st">  </span><span class="kw">addPolygons</span>(</span>
<span id="cb217-23"><a href="matching.html#cb217-23"></a>    <span class="dt">data =</span> match_set_tract[<span class="op">-</span><span class="dv">1</span>, ]</span>
<span id="cb217-24"><a href="matching.html#cb217-24"></a>  )</span></code></pre></div>
<div id="htmlwidget-a8736da947291c60c4e4" style="width:672px;height:480px;" class="leaflet html-widget"></div>
<script type="application/json" data-for="htmlwidget-a8736da947291c60c4e4">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addProviderTiles","args":["CartoDB.Positron",null,null,{"errorTileUrl":"","noWrap":false,"detectRetina":false}]},{"method":"addPolygons","args":[[[[{"lng":[-122.141775,-122.139233,-122.139276,-122.139416,-122.139542,-122.139479,-122.135113,-122.134384,-122.131892,-122.121299,-122.121044067502,-122.123137,-122.117547,-122.11516140516,-122.117693,-122.123835,-122.121772,-122.122375,-122.125976,-122.127856,-122.129912,-122.135986,-122.140784,-122.141775],"lat":[37.462601,37.462577,37.464167,37.468479,37.470749,37.471714,37.471769,37.471922,37.472917,37.476722,37.4765489522726,37.474,37.467572,37.4662797321484,37.465238,37.461215,37.454241,37.453376,37.453554,37.452737,37.453851,37.457446,37.460265,37.462601]}]]],null,null,{"interactive":true,"className":"","stroke":true,"color":"red","weight":5,"opacity":0.5,"fill":true,"fillColor":"red","fillOpacity":0.2,"smoothFactor":1,"noClip":false},null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addPolygons","args":[[[[{"lng":[-121.840337,-121.837564,-121.832974,-121.829038,-121.828103,-121.826515,-121.825302,-121.824833,-121.831756,-121.834479,-121.836973,-121.837411,-121.839609,-121.843109,-121.840337],"lat":[37.341766,37.343655,37.338933,37.334878,37.335508,37.334019,37.334683,37.332979,37.328287,37.331039,37.333597,37.334046,37.336302,37.339904,37.341766]}]],[[{"lng":[-121.816801,-121.812175,-121.808557,-121.805078,-121.804028,-121.803982,-121.805898,-121.811629,-121.814298,-121.815066,-121.819147,-121.816801],"lat":[37.357734,37.360885,37.357614,37.356007,37.355428,37.354659,37.351776,37.347889,37.350818,37.351667,37.356142,37.357734]}]],[[{"lng":[-121.809315,-121.808069,-121.804856,-121.803879,-121.80191,-121.797881,-121.799346,-121.801832,-121.800544,-121.802691,-121.807179,-121.807901,-121.810835,-121.809315],"lat":[37.308844,37.311433,37.311964,37.312173,37.312416,37.306615,37.305764,37.305464,37.299626,37.299771,37.303055,37.303657,37.30713,37.308844]}]],[[{"lng":[-121.840205,-121.836509,-121.831763,-121.827314,-121.824692,-121.825404,-121.829148,-121.832504,-121.835043,-121.838962,-121.840863,-121.840205],"lat":[37.312787,37.315172,37.318457,37.313867,37.311164,37.309777,37.307554,37.305351,37.307962,37.31025,37.312371,37.312787]}]],[[{"lng":[-121.811629,-121.805898,-121.803982,-121.804028,-121.801604,-121.801411,-121.799906,-121.79703,-121.794856,-121.790636,-121.796091,-121.798254,-121.802402,-121.808585,-121.808863,-121.811132,-121.811629],"lat":[37.347889,37.351776,37.354659,37.355428,37.355527,37.353548,37.352573,37.350594,37.349101,37.346218,37.343429,37.344871,37.347693,37.344549,37.34474,37.347343,37.347889]}]],[[{"lng":[-122.05168,-122.046934,-122.046779,-122.044644,-122.038298,-122.036627,-122.034346,-122.03422,-122.029599,-122.028079,-122.02324,-122.031063,-122.034387,-122.039459,-122.050451,-122.052527,-122.05168],"lat":[37.625745,37.629598,37.629678,37.627777,37.622279,37.620803,37.618819,37.618708,37.614671,37.613329,37.609048,37.608957,37.608962,37.613404,37.623241,37.625077,37.625745]}]],[[{"lng":[-121.825893,-121.822327,-121.812947,-121.812686,-121.809591,-121.808441,-121.808217,-121.807999,-121.807718,-121.808069,-121.809315,-121.810835,-121.813428,-121.817474,-121.817951,-121.818142,-121.82082,-121.822419,-121.825893],"lat":[37.322371,37.324781,37.331119,37.331139,37.326624,37.323855,37.322704,37.317669,37.313865,37.311433,37.308844,37.30713,37.310167,37.313544,37.314036,37.314236,37.317039,37.318719,37.322371]}]],[[{"lng":[-122.471743,-122.469834,-122.466574,-122.466344,-122.463482,-122.462974,-122.462217,-122.46202,-122.461819,-122.461732,-122.465149,-122.465067,-122.469014,-122.470603,-122.471587,-122.4717,-122.471743],"lat":[37.701518,37.701872,37.701478,37.701277,37.701288,37.703169,37.703155,37.697389,37.693588,37.693024,37.69292,37.693378,37.693366,37.693306,37.698025,37.700079,37.701518]}]],[[{"lng":[-122.086765,-122.084323,-122.083642,-122.083513,-122.081222,-122.081225,-122.07847,-122.075885,-122.074324,-122.073242,-122.07446,-122.077526,-122.084513,-122.087898,-122.086765],"lat":[37.63688,37.63694,37.636955,37.639593,37.639636,37.640842,37.640942,37.636457,37.632183,37.631424,37.631336,37.631403,37.631558,37.636326,37.63688]}]],[[{"lng":[-121.852651,-121.846795,-121.840765,-121.838531,-121.837878,-121.837798,-121.838539,-121.841367,-121.843745,-121.846326,-121.849307,-121.8513,-121.852121,-121.852651],"lat":[37.34985,37.352655,37.355521,37.355648,37.354077,37.352481,37.349971,37.347113,37.345233,37.343204,37.346312,37.348338,37.349297,37.34985]}]],[[{"lng":[-122.040007,-122.035275,-122.033806,-122.030598,-122.03051,-122.026235,-122.022895,-122.020081,-122.017348,-122.018923,-122.022761,-122.023339,-122.023394,-122.025828,-122.029818,-122.037187,-122.040007],"lat":[37.529433,37.531105,37.532891,37.536824,37.536931,37.54225,37.546533,37.542769,37.539133,37.537007,37.532587,37.53242,37.531883,37.528748,37.523848,37.527311,37.529433]}]],[[{"lng":[-122.044662,-122.04028,-122.034932,-122.033659,-122.034038,-122.029328,-122.028878,-122.028316,-122.026235,-122.03051,-122.030598,-122.033806,-122.035275,-122.040007,-122.041936,-122.044662],"lat":[37.533296,37.536316,37.539829,37.539735,37.540445,37.544359,37.544635,37.543662,37.54225,37.536931,37.536824,37.532891,37.531105,37.529433,37.531053,37.533296]}]],[[{"lng":[-122.433716,-122.42858,-122.426924,-122.424064,-122.420538,-122.410656,-122.410247,-122.41021,-122.408268,-122.406389,-122.404919,-122.404025,-122.399439,-122.398932,-122.398776,-122.397336,-122.396476,-122.395679,-122.393139,-122.393186,-122.388221,-122.380995,-122.380995,-122.374291,-122.376241,-122.380044,-122.387245,-122.391215,-122.389313,-122.384322,-122.38049553644,-122.38191,-122.392182,-122.398341,-122.401995,-122.403661,-122.405412,-122.406059,-122.406886,-122.411311,-122.411425,-122.411577,-122.416763,-122.417316,-122.419006,-122.423331,-122.423435,-122.423462,-122.424997,-122.427492,-122.429534,-122.433353,-122.434433,-122.433716],"lat":[37.655502,37.65278,37.652069,37.655237,37.654473,37.652009,37.651583,37.650026,37.653711,37.657442,37.660116,37.661097,37.664126,37.664519,37.664635,37.665922,37.666801,37.667715,37.670034,37.669493,37.671784,37.6717699703916,37.667855,37.662206,37.655249,37.647721,37.64734,37.646404,37.640193,37.640382,37.6353526118977,37.635399,37.635134,37.635134,37.635476,37.635538,37.635401,37.635128,37.635269,37.635537,37.641228,37.641231,37.639353,37.639188,37.64198,37.64034,37.640472,37.640514,37.642668,37.64605,37.648748,37.654157,37.655079,37.655502]}]],[[{"lng":[-122.09239,-122.091557,-122.091741,-122.089057,-122.08829,-122.087494,-122.087429,-122.082241,-122.074482,-122.074039,-122.069993,-122.072253,-122.075163,-122.07609,-122.07757,-122.078051,-122.081177,-122.081,-122.084393,-122.088206,-122.091951,-122.09239],"lat":[37.593747,37.594814,37.601123,37.606513,37.607486,37.608144,37.608193,37.603713,37.596914,37.596464,37.592375,37.591093,37.592426,37.592285,37.591673,37.591591,37.591604,37.593922,37.594808,37.593078,37.592747,37.593747]}]],[[{"lng":[-121.821967,-121.819399,-121.818003,-121.816183,-121.816554,-121.812811,-121.811132,-121.808863,-121.808585,-121.806464,-121.805913,-121.817439,-121.81998,-121.820054,-121.821967],"lat":[37.343463,37.344759,37.343546,37.344277,37.345629,37.347474,37.347343,37.34474,37.344549,37.342135,37.341519,37.337819,37.340597,37.340738,37.343463]}]],[[{"lng":[-121.824947,-121.813626,-121.81337,-121.810162,-121.809545,-121.809529,-121.809358,-121.808582,-121.806817,-121.805915,-121.806101,-121.80599,-121.8085,-121.809921,-121.811167,-121.817411,-121.820952,-121.822336,-121.822433,-121.823353,-121.82339,-121.823476,-121.82368,-121.824947],"lat":[37.284447,37.284112,37.284089,37.284801,37.285676,37.285244,37.283694,37.281774,37.278948,37.277584,37.277655,37.277214,37.277516,37.277071,37.277278,37.276349,37.276825,37.277772,37.278841,37.278884,37.279592,37.282388,37.282983,37.284447]}]],[[{"lng":[-122.059911423613,-122.058336,-122.045995496045,-122.045901,-122.04566296427,-122.038599,-122.038599,-122.040872722043,-122.036182,-122.025425,-122.020872,-121.996671,-121.992669,-121.980014,-121.975071,-121.968524,-121.964157,-121.959313,-121.951921,-121.947842,-121.946174,-121.947087,-121.945479,-121.944522,-121.944335,-121.941085,-121.938903,-121.936025,-121.934987,-121.935137,-121.934116,-121.931199,-121.931128,-121.932656,-121.932626,-121.928297,-121.9279,-121.925041,-121.922569,-121.922948,-121.922671,-121.919898,-121.918201,-121.916331,-121.919778,-121.926724,-121.932829,-121.943763,-121.957565,-121.959198,-121.967901,-121.972543,-121.98632,-121.986838,-121.987577,-121.989179,-121.995782,-122.00479,-122.006109,-122.01289,-122.020378,-122.02713,-122.032916,-122.035937,-122.037361,-122.037273,-122.03709,-122.036789,-122.034672,-122.041135,-122.043572,-122.049172,-122.054472,-122.059673,-122.060006,-122.059911423613],"lat":[37.4473360004136,37.446788,37.4490347954125,37.449052,37.4492335747765,37.454622,37.462048,37.4628633674882,37.464966,37.46563,37.465139,37.467239,37.464639,37.460892,37.460639,37.461953,37.463151,37.463515,37.461461,37.461978,37.463946,37.467424,37.469168,37.468889,37.466093,37.464948,37.462394,37.462929,37.462464,37.46084,37.460331,37.460644,37.45739,37.456919,37.455147,37.457332,37.455352,37.454186,37.455538,37.45505,37.453645,37.440032,37.430066,37.425596,37.423887,37.422564,37.421792,37.419322,37.419293,37.419172,37.418654,37.417974,37.412231,37.412059,37.411822,37.4114,37.409928,37.407976,37.407689,37.40614,37.40444,37.40313,37.401676,37.400637,37.400906,37.401432,37.41284,37.421494,37.426438,37.427012,37.427239,37.426139,37.435739,37.434039,37.443622,37.4473360004136]}]],[[{"lng":[-121.808441,-121.807759,-121.800474,-121.796957,-121.79644,-121.796029,-121.795317,-121.791524,-121.791769,-121.794575,-121.796141,-121.80191,-121.803879,-121.804856,-121.808069,-121.807718,-121.807999,-121.808217,-121.808441],"lat":[37.323855,37.324034,37.325583,37.324918,37.323396,37.321943,37.320066,37.313966,37.31404,37.313523,37.313289,37.312416,37.312173,37.311964,37.311433,37.313865,37.317669,37.322704,37.323855]}]],[[{"lng":[-121.827928,-121.826694,-121.825346,-121.824461,-121.824088,-121.82345,-121.821254,-121.818591,-121.816969,-121.815149,-121.814473,-121.810882,-121.812697,-121.813573,-121.816052,-121.816304,-121.817579,-121.820245,-121.824685,-121.824727,-121.825438,-121.82553,-121.825942,-121.827185,-121.827928],"lat":[37.365737,37.366961,37.369186,37.37061,37.371199,37.372233,37.375661,37.374584,37.373952,37.37322,37.372922,37.371362,37.370133,37.369903,37.368209,37.368045,37.367194,37.365356,37.362339,37.362248,37.363039,37.363142,37.363593,37.36494,37.365737]}]],[[{"lng":[-121.834061,-121.832647,-121.827006,-121.824889,-121.822848,-121.821967,-121.820054,-121.821511,-121.826323,-121.82797,-121.830159,-121.834837,-121.834061],"lat":[37.346029,37.346986,37.350833,37.347654,37.344718,37.343463,37.340738,37.339952,37.336712,37.338412,37.340671,37.3455,37.346029]}]]],null,null,{"interactive":true,"className":"","stroke":true,"color":"#03F","weight":5,"opacity":0.5,"fill":true,"fillColor":"#03F","fillOpacity":0.2,"smoothFactor":1,"noClip":false},null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]}],"limits":{"lat":[37.276349,37.703169],"lng":[-122.471743,-121.790636]}},"evals":[],"jsHooks":[]}</script>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="training-and-testing-data.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="difference-in-differences.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": null,
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "none",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
},
"search": false,
"info": false
});
});
</script>

</body>

</html>
